# Message Display Issues and Solutions

## Overview
This document outlines the various message display issues encountered in the Calendar AI Assistant Panel and the approaches used to resolve them. These issues primarily involved message ordering, persistence, duplication, and proper rendering of multipart messages.

## Issues Identified

### 1. TanStack Query DevTools Button Overlap
**Problem**: The floating TanStack Query DevTools button was overlapping with other UI elements in the interface.

**Solution**: Changed the `buttonPosition` from default to "top-right" in `QueryProvider.tsx`:
```typescript
<ReactQueryDevtools initialIsOpen={false} buttonPosition="top-right" />
```

### 2. Calendar Events Authentication Issues
**Problem**: Supabase client session management was causing "Auth session missing!" errors when fetching calendar events from Mastra tools.

**Solution**: Created a Supabase Edge Function (`supabase/functions/calendar-events/index.ts`) to handle authentication server-side:
- Supports both date ranges (`?startDate=...&endDate=...`) and specific dates (`?dates=...`)
- Handles JWT authentication using Authorization headers
- Updated Mastra tool to call the edge function instead of using Supabase client directly

### 3. Message Order Issues
**Problem**: Messages were displaying in wrong order (newest first instead of oldest first) in the chat interface.

**Root Cause**:
- Mastra API doesn't support ordering parameters for message retrieval
- Missing or inconsistent `createdAt` timestamps in combined message arrays

**Solution**: Implemented client-side sorting in `mastra-api.ts`:
```typescript
const sortedMessages = messages.sort((a, b) => {
  const aTime = new Date(a.createdAt).getTime();
  const bTime = new Date(b.createdAt).getTime();
  return aTime - bTime; // Ascending order (oldest first)
});
```

### 4. Missing Agent Responses After Tool Execution
**Problem**: Agent responses following tool execution were not displaying when returning to conversations, even though they were stored in the database.

**Root Cause**: UI filtering logic was incorrectly removing or not properly rendering stored messages that contained agent responses after tool calls.

**Solution**: Ensured all stored messages from the database are properly displayed by fixing the message combination and rendering logic.

### 5. React Key Collisions
**Problem**: "Encountered two children with the same key" errors causing duplicate message rendering.

**Root Cause**: Same message IDs appearing multiple times with different roles/parts in the message arrays.

**Solution**: Used composite keys that include message index: `${message.id}-${messageIndex}`

### 6. Multipart Message Display
**Problem**: Messages with multiple parts (text + tool calls + tool results) were being displayed as separate message bubbles instead of a single coherent conversation bubble.

**Solution**: Implemented "ONE BUBBLE WITH ALL PARTS" approach in `ai-assistant-panel.tsx`:
```typescript
<Message from={message.role}>
  <MessageContent>
    {message.parts?.map((part: any, i: number) => {
      if (part.type === 'text') {
        return <div key={`text-${i}`}><Response>{part.text}</Response></div>;
      }
      if (part.type === 'tool-call') {
        return <div key={`tool-call-${i}`}><Tool>...</Tool></div>;
      }
      if (part.type === 'tool-result') {
        return <div key={`tool-result-${i}`}><Tool>...</Tool></div>;
      }
      // Handle other part types...
    })}
  </MessageContent>
</Message>
```

### 7. Missing createdAt Timestamps
**Problem**: Combined messages were showing "no date" in debug logs, preventing proper chronological sorting.

**Root Cause**:
- Stored messages from Mastra had timestamps in `metadata.createdAt`
- Live `useChat` messages didn't have timestamps at all

**Solution**: Implemented timestamp extraction and normalization in `ai-assistant-panel.tsx`:
```typescript
// Process stored messages to extract createdAt from metadata
const processedStoredMessages = conversationMessages.map(msg => ({
  ...msg,
  createdAt: msg.metadata?.createdAt || msg.createdAt
}));

// Process live messages to add current timestamp if missing
const processedLiveMessages = messages
  .filter(msg => !conversationMessages.some(cm => cm.id === msg.id))
  .map(msg => ({
    ...msg,
    createdAt: msg.createdAt || new Date().toISOString()
  }));
```

## Technical Architecture Context

### Message Flow
1. **Live Messages**: Generated by AI SDK `useChat` hook during active streaming
2. **Stored Messages**: Retrieved from Mastra memory system via API calls
3. **Combined Messages**: Merged array avoiding duplicates, properly sorted chronologically

### Message Structure
Messages can contain multiple parts:
- `text`: Regular text content
- `tool-call`: Function/tool invocation
- `tool-result`: Results from tool execution
- `tool-invocation`: Streaming tool invocations

### Key Components
- `ai-assistant-panel.tsx`: Main chat interface with message rendering
- `mastra-api.ts`: Client for Mastra memory API with message formatting
- `supabase/functions/calendar-events/index.ts`: Edge function for calendar data
- `conversation-selector.tsx`: UI for switching between conversations

## Debugging Approaches

### Message Flow Debugging
- Added console logging for message order tracking
- Logged message structure and parts for analysis
- Tracked timestamp extraction and sorting operations

### Authentication Flow Debugging
- Verified JWT token availability in Mastra tools
- Checked edge function response status and error messages
- Validated Supabase authentication in edge functions

### UI State Debugging
- Used React DevTools to inspect component state
- Added debug logs for message combination logic
- Tracked conversation selection and persistence

## Lessons Learned

1. **Edge Functions for Authentication**: Using Supabase Edge Functions is more reliable than client-side session management for server-to-server API calls from Mastra tools.

2. **Message Timestamp Handling**: Always ensure consistent timestamp formats across different message sources (live vs stored).

3. **Multipart Message UX**: Complex messages with multiple parts should be rendered as single conversation units, not fragmented across multiple bubbles.

4. **Client-Side Sorting**: When APIs don't support ordering, implement reliable client-side sorting with proper timestamp handling.

5. **Debug Logging**: Comprehensive logging during development is crucial for tracking message flow through complex systems involving multiple APIs and state management layers.

## Files Modified

### Frontend (apps/calendar)
- `src/providers/QueryProvider.tsx` - DevTools button positioning
- `src/components/ai-assistant-panel.tsx` - Message rendering and ordering fixes
- `src/lib/mastra-api.ts` - Message sorting and timestamp handling

### Backend (supabase)
- `functions/calendar-events/index.ts` - New edge function for calendar queries
- `functions/calendar-events/deno.json` - Edge function configuration

### Agent (apps/agent)
- `src/mastra/tools/calendar-events.ts` - Updated to use edge function

## Testing Recommendations

1. **Message Order Testing**: Create conversations with multiple messages and verify chronological ordering
2. **Tool Execution Testing**: Test agent responses after tool calls are properly persisted and displayed
3. **Authentication Testing**: Verify edge function authentication with various JWT scenarios
4. **Multipart Message Testing**: Test messages containing text + tool calls + results render as single bubbles
5. **Conversation Switching**: Test message persistence when switching between conversations